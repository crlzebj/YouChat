<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouChat</title>
</head>
<body>
<ul id="list"></ul>
<input type="text" id="message" placeholder="请输入消息">
<button id="send">发送</button>

<script>
    // 从 URL 获取 token 参数
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
        alert("Token 不存在，无法连接 WebSocket！");
        window.location.href = './test.html'; // 如果没有 token，跳转回登录页面
    }

    // 创建一个 WebSocket 连接，使用从 URL 获取的 token
    const socket = new WebSocket(`ws://localhost:9090/websocket?token=${token}`);

    // 监听连接打开事件
    socket.addEventListener('open', (event) => {
        console.log('WebSocket is open now.');
    });

    // 监听消息事件
    socket.addEventListener('message', (event) => {
        console.log('Message from server: ', event.data);
        var layer = document.createElement("div");
        var txt = document.createTextNode(event.data);
        layer.setAttribute("id", "WndName");
        layer.appendChild(txt);
        document.body.appendChild(layer);
    });

    // 监听错误事件
    socket.addEventListener('error', (error) => {
        console.error('WebSocket encountered error: ', error);
    });

    // 监听连接关闭事件
    socket.addEventListener('close', (event) => {
        console.log('WebSocket is closed now.');
    });

    // 监听发送按钮点击事件
    document.getElementById('send').addEventListener('click', () => {
        const message = document.getElementById('message').value;
        if (message && socket.readyState === WebSocket.OPEN) {
            var json = {};
            json.type = 1;  // 消息类型，可能是文本、文件等
            json.receiverId = 90879658;  // 假设这个是接收方的 ID，实际情况应根据需要修改
            json.data = message;  // 发送的消息内容

            // 发送消息到 WebSocket
            socket.send(JSON.stringify(json));
            console.log('Message sent:', message);
        } else if (socket.readyState !== WebSocket.OPEN) {
            console.error('WebSocket is not open.');
        } else {
            console.warn('Message is empty.');
        }

        // 清空输入框
        document.getElementById('message').value = '';
    });
</script>

</body>
</html>
